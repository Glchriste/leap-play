<!doctype html>
<meta charset="utf-8">
<h4>x/y animation</h4>
<canvas id="visualizer" width=100 height=100></canvas>
<h4>Time between messages</h4>
<p>
Min: <strong id="delta-min"></strong> ms | 
Max: <strong id="delta-max"></strong> ms |
Ave: <strong id="delta-ave"></strong> ms |
Total: <strong id="delta-total"></strong> ms |
Messages: <strong id="msg-total"></strong>
</p>
<canvas id="deltas" width=200 height=50></canvas>
<h4>Number of Pointables</h4>
<canvas id="pointables" width=200 height=60></canvas>
<h4>Average pointable velocity</h4>
<canvas id="velocities" width=200 height=60></canvas>
<script src="js/lib/d3.v3.js"></script>
<script>
d3.json("data/gestures/frolic-1.json", function(error, data) {
  if (error) {
    alert(error.statusText);
    return
  }

  window.data = data;
  fleas(data);
  between(data);
  pointables(data);
  velocities(data);
});

/* Animated 2d visualization */
function fleas(data) {
  var last = data.length-1;
  var i = 0;
  var duration = (data[last].timestamp - data[0].timestamp)/1000;
  var step = duration/data.length;

  var canvas = document.getElementById("visualizer");
  var ctx = canvas.getContext("2d");
  var x = d3.scale.linear().range([0,canvas.width]).domain([-200,200]);
  var y = d3.scale.linear().range([canvas.height,0]).domain([0,400]);

  function renderPointables(obj) {
    ctx.fillStyle = "rgba(255,255,255,0.4)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#111";
    if ("pointables" in obj) {
      obj.pointables.forEach(function(p) {
        var pos = p.tipPosition;
        ctx.fillRect(x(pos[0]), y(pos[1]), 3, 3);
      });
    }
  };

  function run() {
    if (i == last) return;
    renderPointables(data[i]);
    i++;
    setTimeout(run, step);
  };
  run();
};

/* see time between messages */
function between(data) {
  var deltas = data.slice(1).map(function(d,i) {
    return d.timestamp - data[i].timestamp;
  });

  var canvas = document.getElementById("deltas");
  canvas.width = deltas.length*2;
  var ctx = canvas.getContext("2d");
  var extents = d3.extent(deltas);
  var duration = (data[data.length-1].timestamp - data[0].timestamp)/1000;
  var y = d3.scale.linear().range([canvas.height,0]).domain([0,extents[1]]);
  d3.select("#delta-min").text(extents[0]/1000);
  d3.select("#delta-max").text(extents[1]/1000);
  d3.select("#delta-ave").text((duration/data.length).toPrecision(5));
  d3.select("#delta-total").text(duration);
  d3.select("#msg-total").text(data.length);

  deltas.forEach(function(d,i) {
    ctx.fillRect(2*i,y(d),1,canvas.height-y(d));
  });
};

/* number of pointables */
function pointables(data) {
  var pointables_per_msg = data.map(function(d,i) {
    if ("pointables" in d) return d.pointables.length;
    return 0;
  });

  var canvas = document.getElementById("pointables");
  canvas.width = pointables_per_msg.length*2;
  var ctx = canvas.getContext("2d");

  pointables_per_msg.forEach(function(d,i) {
    d3.range(d).forEach(function(j) {
      ctx.fillRect(2*i,canvas.height-j*5,1,4);
    });
  });
};

/* average pointable velocities */
function velocities(data) {
  var velocities = data.map(function(d,i) {
    if ("pointables" in d) {
      var summed = 0;
      var ave_velocities = d.pointables.forEach(function(p) {
        var vel = p.tipVelocity;
        summed += Math.sqrt(vel[0]*vel[0]+vel[1]*vel[1]+vel[2]*vel[2]);
      });
      return summed/d.pointables.length || 0;
    }
    return 0;
  });
  var canvas = document.getElementById("velocities");
  canvas.width = velocities.length*2;
  var ctx = canvas.getContext("2d");
  var extents = d3.extent(velocities);
  var y = d3.scale.linear().range([canvas.height,0]).domain([0,extents[1]]);


  velocities.forEach(function(d,i) {
    ctx.fillRect(2*i,y(d),1,canvas.height-y(d));
  });
};
</script>
<style>
body {
  font-size: 14px;
  font-family: Helvetica, Arial, sans-serif;
}
h4 {
  margin: 20px 0 0 4px;
}
</style>
